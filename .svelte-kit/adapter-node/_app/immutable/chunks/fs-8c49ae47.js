import{h as o,e as g,d as w,b as A}from"./store-3e4ea696.js";import{S as y,a as b,g as F}from"./system-eda41220.js";import{s as N,e as M,b as S}from"./utils-a62a4de9.js";import{g as a}from"./index-ff400fad.js";import d from"short-uuid";import*as m from"idb-keyval";import"./finder-762cc408.js";import{Buffer as T}from"buffer";import{i as D,d as C,u as v,c as z,s as O}from"./admin-04ad1b95.js";function K(){g.set("copy"),w.set(a(A)),console.log("copy")}function P(){g.set("cut"),w.set(a(A)),console.log("cut")}function Q(e,t=null){if(console.log("paste to",e),console.log("clipboard_op",a(g)),console.log(a(o)[e]),a(o)[e]==null||a(o)[e].type=="file"){console.log("target is not a dir");return}if(a(w).length==0){console.log("clipboard is empty");return}for(let r of a(w))E(r,e,t),a(g)=="cut"&&I(r);g.set("copy")}async function I(e){if(F.includes(e)){console.log(e,"is protected");return}let t=a(o)[e];if(!t)return;const r=a(D),l=t.is_admin||t.storage_type==="admin";let s=[...t.children];for(let i of s)await I(i);if(r&&l&&await C(e),a(o)[t.parent]!=null&&(console.log("delete from parent",t.parent),o.update(i=>(i[t.parent].children=i[t.parent].children.filter(f=>f!=t.id),i[t.parent].date_modified=new Date().getTime(),i)),r&&l)){const i=a(o)[t.parent];i&&i.is_admin&&await v(t.parent,i.children)}o.update(i=>(delete i[e],i))}function j(e,t){if(e==null||t==null||a(o)[e]==null||a(o)[t]==null)return!1;if(e==t)return!0;let r=[];for(;a(o)[t].parent!=null;){let l=a(o)[t].parent;r.push(l),t=l}return r.includes(e)}function E(e,t,r=null){if(j(e,t)){console.log("cannot paste item onto itself");return}let l={...a(o)[e]};r==null?l.id=d.generate():l.id=r,l.parent=t;let s=[...a(o)[t].children.map(u=>a(o)[u].name)],i=2,f=l.basename;for(;s.includes(f+l.ext);)f=l.basename+" "+i,i++;l.basename=f,l.name=f+l.ext,console.log(l);let n=[...l.children];l.children=[],o.update(u=>(u[l.id]=l,u)),console.log("cloning",l.id),o.update(u=>(u[t].children.push(l.id),u[t].date_modified=new Date().getTime(),u));for(let u of[...n])E(u,l.id)}async function U(e,t,r,l,s=null){if(e==null||r==null||l==null)return;const i=a(D);let f=new Date().getTime(),n={id:d.generate(),type:e,path:"",name:"",storage_type:i?"admin":"local",url:d.generate(),ext:t,level:0,parent:l,size:1,children:[],basename:"",date_created:f,date_modified:f,sort_option:y.NONE,sort_order:b.ASCENDING,is_admin:i},h=[...a(o)[l].children.map(c=>a(o)[c]).map(c=>c.name)],p=2;r=N(r);let _=r;for(;h.includes(_+t);)_=r+" "+p,p++;if(n.basename=_,n.name=_+n.ext,s!=null)if(i){const c=await z(s,n.id);c.success&&(n.url=c.url,n.size=c.size,n.storage_type="remote")}else await m.set(n.url,s),n.size=Math.ceil(s.size/1024);else if(e=="file")if(console.log("fetch empty file"),s=await x(`/empty/empty${n.ext}`,n.name),i){const c=await z(s,n.id);c.success&&(n.url=c.url,n.size=c.size,n.storage_type="remote")}else await m.set(n.url,s),n.size=Math.ceil(s.size/1024);else n.url="";if(o.update(c=>(c[n.id]=n,c)),o.update(c=>(c[l].children.push(n.id),c[l].date_modified=f,c)),i){await O(n);const c=a(o)[l];c.is_admin&&await v(l,c.children)}return n.id}async function V(e,t){if(t==null)return;e.id=d.generate(),e.parent=t,["file","folder"].includes(e.type)||(e.type="file"),e.storage_type==null&&(e.storage_type="local"),e.ext==null&&(e.ext=""),e.icon==null&&(e.icon="/images/xp/icons/ApplicationWindow.png"),e.children==null&&(e.children=[]);let r=new Date().getTime();e.date_created=r,e.date_modified=r,e.sort_option=y.NONE,e.sort_order=b.ASCENDING;let s=[...a(o)[t].children.map(u=>a(o)[u]).map(u=>u.name)],i=2,f=N(e.basename),n=f;for(;s.includes(n+e.ext);)n=f+" "+i,i++;return e.basename=n,e.name=n+e.ext,e.file!=null?(e.url=d.generate(),await m.set(e.url,e.file),e.size=Math.ceil(file.size/1024),delete e.file):e.executable&&(e.url="./programs/webapp.svelte"),o.update(u=>(u[e.id]=e,u)),o.update(u=>(u[t].children.push(e.id),u[t].date_modified=r,u)),e.id}async function X(e,t){if(a(o)[e]==null){console.log(e,"not exist");return}let r=d.generate();await m.set(r,t);let l=a(o)[e].parent,s=new Date().getTime();o.update(i=>(i[e].url=r,i[e].storage_type="local",i[e].date_modified=s,i[l].date_modified=s,i))}async function Y(e,t,r,l,s=null){t=t.toLowerCase(),M(e)==t&&(e=S(e,t));let i=d.generate();await m.set(i,r),s==null&&(s=d.generate());let f=new Date().getTime(),n={id:s,type:"file",path:"",name:e+t,storage_type:"local",url:i,ext:t,level:0,parent:l,size:Math.round(r.size/1024),children:[],basename:e,date_created:f,date_modified:f,sort_option:y.NONE,sort_order:b.ASCENDING},u=[...a(o)[l].children.map(p=>a(o)[p].name)],h=2;for(e=n.basename;u.includes(e+n.ext);)e=n.basename+" "+h,h++;n.basename=e,n.name=e+n.ext,o.update(p=>(p[n.id]=n,p[l].children.push(n.id),p[l].date_modified=f,p))}async function Z(e){let t=a(o)[e],r;return t.storage_type=="remote"?r=await x(t.url):t.storage_type=="local"&&(r=await m.get(t.url),console.log(r)),r=new File([r],t.name,{type:r.type}),r}async function x(e,t,r="image/jpeg"){try{const s=await(await fetch(e)).blob();return new File([s],t,{type:s.type||r})}catch{return new File([""],"empty.txt",{type:"text/plain"})}}async function G(e){return await(await x(e)).arrayBuffer()}async function $(e){let t=await G(e);return console.log(t),T.from(t)}export{Y as a,$ as b,U as c,E as d,P as e,K as f,Z as g,I as h,V as n,Q as p,X as s};
