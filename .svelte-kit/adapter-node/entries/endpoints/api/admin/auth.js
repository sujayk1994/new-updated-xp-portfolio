import{a as p,g as u,b as d,c as f}from"../../../../_app/immutable/chunks/auth-e33c57ab.js";import{i as y}from"../../../../_app/immutable/chunks/db-aae5410a.js";import"bcrypt";import"jsonwebtoken";import"crypto";import"pg";let m=!1;async function l(){m||(await y(),m=!0)}async function T({request:a}){await l();const o=await a.json(),{action:s,username:n,password:i}=o;if(s==="login"){const t=await p(n,i);if(!t)return new Response(JSON.stringify({success:!1,error:"Invalid credentials"}),{status:401,headers:{"Content-Type":"application/json"}});const e=u(t);return new Response(JSON.stringify({success:!0,token:e,admin:{username:t.username}}),{status:200,headers:{"Content-Type":"application/json","Set-Cookie":`admin_token=${e}; Path=/; HttpOnly; SameSite=Strict; Max-Age=604800`}})}if(s==="register"){if(await d())return new Response(JSON.stringify({success:!1,error:"Admin already exists"}),{status:400,headers:{"Content-Type":"application/json"}});const e=await f(n,i);if(!e.success)return new Response(JSON.stringify({success:!1,error:e.error}),{status:400,headers:{"Content-Type":"application/json"}});const r=await p(n,i),c=u(r);return new Response(JSON.stringify({success:!0,token:c,admin:{username:r.username}}),{status:200,headers:{"Content-Type":"application/json","Set-Cookie":`admin_token=${c}; Path=/; HttpOnly; SameSite=Strict; Max-Age=604800`}})}return s==="logout"?new Response(JSON.stringify({success:!0}),{status:200,headers:{"Content-Type":"application/json","Set-Cookie":"admin_token=; Path=/; HttpOnly; SameSite=Strict; Max-Age=0"}}):new Response(JSON.stringify({error:"Invalid action"}),{status:400,headers:{"Content-Type":"application/json"}})}async function j({request:a}){await l();const o=a.headers.get("cookie")||"",s=Object.fromEntries(o.split(";").map(i=>{const[t,...e]=i.trim().split("=");return[t,e.join("=")]})),n=await d();return new Response(JSON.stringify({adminExists:n,hasToken:!!s.admin_token}),{status:200,headers:{"Content-Type":"application/json"}})}export{j as GET,T as POST};
