import{q as m,i as O}from"../../../../_app/immutable/chunks/db-aae5410a.js";import{v as $}from"../../../../_app/immutable/chunks/auth-e33c57ab.js";import"pg";import"bcrypt";import"jsonwebtoken";import"crypto";let N=!1;async function b(){N||(await O(),N=!0)}function E(e){const a=e.headers.get("cookie")||"";return Object.fromEntries(a.split(";").map(n=>{const[t,...o]=n.trim().split("=");return[t,o.join("=")]})).admin_token}function v(e){if(!e)return null;const a=[/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/,/^([a-zA-Z0-9_-]{11})$/];for(const u of a){const n=e.match(u);if(n)return n[1]}return null}async function I({request:e}){await b();const a=E(e);if(!$(a))return new Response(JSON.stringify({error:"Unauthorized"}),{status:401,headers:{"Content-Type":"application/json"}});try{const n=await m("SELECT * FROM admin_videos ORDER BY display_order ASC, created_at DESC");return new Response(JSON.stringify({success:!0,videos:n.rows}),{status:200,headers:{"Content-Type":"application/json"}})}catch(n){return console.error("Error fetching videos:",n),new Response(JSON.stringify({error:"Failed to fetch videos"}),{status:500,headers:{"Content-Type":"application/json"}})}}async function k({request:e}){await b();const a=E(e);if(!$(a))return new Response(JSON.stringify({error:"Unauthorized"}),{status:401,headers:{"Content-Type":"application/json"}});try{const n=await e.json(),{title:t,youtubeUrl:o,channel:d,description:c,duration:l,views:f,thumbnailUrl:y,isPublic:h,displayOrder:w}=n;if(!t||!o)return new Response(JSON.stringify({error:"Title and YouTube URL are required"}),{status:400,headers:{"Content-Type":"application/json"}});const p=v(o);if(!p)return new Response(JSON.stringify({error:"Invalid YouTube URL"}),{status:400,headers:{"Content-Type":"application/json"}});const T=await m(`INSERT INTO admin_videos (title, youtube_id, channel, description, duration, views, thumbnail_url, is_public, display_order)
             VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
             RETURNING *`,[t,p,d||"Portfolio Channel",c||"",l||"0:00",f||"0 views",y||null,h!==!1,w||0]);return new Response(JSON.stringify({success:!0,video:T.rows[0]}),{status:201,headers:{"Content-Type":"application/json"}})}catch(n){return console.error("Error creating video:",n),new Response(JSON.stringify({error:"Failed to create video"}),{status:500,headers:{"Content-Type":"application/json"}})}}async function D({request:e,url:a}){await b();const u=E(e);if(!$(u))return new Response(JSON.stringify({error:"Unauthorized"}),{status:401,headers:{"Content-Type":"application/json"}});try{const t=await e.json(),{id:o,title:d,youtubeUrl:c,channel:l,description:f,duration:y,views:h,thumbnailUrl:w,isPublic:p,displayOrder:T}=t;if(!o)return new Response(JSON.stringify({error:"Video ID is required"}),{status:400,headers:{"Content-Type":"application/json"}});let R=null;if(c&&(R=v(c),!R))return new Response(JSON.stringify({error:"Invalid YouTube URL"}),{status:400,headers:{"Content-Type":"application/json"}});const s=[],i=[];let r=1;d!==void 0&&(s.push(`title = $${r++}`),i.push(d)),R&&(s.push(`youtube_id = $${r++}`),i.push(R)),l!==void 0&&(s.push(`channel = $${r++}`),i.push(l)),f!==void 0&&(s.push(`description = $${r++}`),i.push(f)),y!==void 0&&(s.push(`duration = $${r++}`),i.push(y)),h!==void 0&&(s.push(`views = $${r++}`),i.push(h)),w!==void 0&&(s.push(`thumbnail_url = $${r++}`),i.push(w)),p!==void 0&&(s.push(`is_public = $${r++}`),i.push(p)),T!==void 0&&(s.push(`display_order = $${r++}`),i.push(T)),s.push("updated_at = CURRENT_TIMESTAMP"),i.push(o);const g=await m(`UPDATE admin_videos SET ${s.join(", ")} WHERE id = $${r} RETURNING *`,i);return g.rows.length===0?new Response(JSON.stringify({error:"Video not found"}),{status:404,headers:{"Content-Type":"application/json"}}):new Response(JSON.stringify({success:!0,video:g.rows[0]}),{status:200,headers:{"Content-Type":"application/json"}})}catch(t){return console.error("Error updating video:",t),new Response(JSON.stringify({error:"Failed to update video"}),{status:500,headers:{"Content-Type":"application/json"}})}}async function z({request:e,url:a}){await b();const u=E(e);if(!$(u))return new Response(JSON.stringify({error:"Unauthorized"}),{status:401,headers:{"Content-Type":"application/json"}});try{const t=await e.json(),{id:o}=t;return o?(await m("DELETE FROM admin_videos WHERE id = $1 RETURNING *",[o])).rows.length===0?new Response(JSON.stringify({error:"Video not found"}),{status:404,headers:{"Content-Type":"application/json"}}):new Response(JSON.stringify({success:!0,message:"Video deleted successfully"}),{status:200,headers:{"Content-Type":"application/json"}}):new Response(JSON.stringify({error:"Video ID is required"}),{status:400,headers:{"Content-Type":"application/json"}})}catch(t){return console.error("Error deleting video:",t),new Response(JSON.stringify({error:"Failed to delete video"}),{status:500,headers:{"Content-Type":"application/json"}})}}export{z as DELETE,I as GET,k as POST,D as PUT};
